<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ลงเวลาเลิกงาน / สรุปการทำงาน - BigC</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Kanit', sans-serif;
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #f5a623 0%, #f39c12 100%);
      padding: 30px;
      text-align: center;
      color: white;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .header .time {
      font-size: 18px;
      opacity: 0.9;
    }
    
    .content {
      padding: 40px 30px;
    }
    
    .work-summary {
      background: linear-gradient(135deg, #f0fff4, #e6fffa);
      border: 1px solid #68d391;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .summary-title {
      font-size: 20px;
      font-weight: 700;
      color: #22543d;
    }
    
    .work-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-not-started { background: #fed7d7; color: #c53030; }
    .status-in-progress { background: #fef5e7; color: #744210; }
    .status-completed { background: #f0fff4; color: #22543d; }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .summary-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    
    .summary-label {
      font-size: 13px;
      color: #718096;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .summary-value {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
    }
    
    .form-section {
      margin-bottom: 40px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }
    
    .form-label.required::after {
      content: ' *';
      color: #e53e3e;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Kanit', sans-serif;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #f5a623;
      box-shadow: 0 0 0 3px rgba(245, 166, 35, 0.1);
    }
    
    .form-input:read-only {
      background: #f7fafc;
      color: #4a5568;
      cursor: not-allowed;
    }
    
    .form-input.error {
      border-color: #e53e3e;
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }
    
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Kanit', sans-serif;
      resize: vertical;
      min-height: 100px;
      transition: all 0.3s ease;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: #f5a623;
      box-shadow: 0 0 0 3px rgba(245, 166, 35, 0.1);
    }
    
    .photo-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .photo-upload {
      border: 3px dashed #cbd5e0;
      border-radius: 12px;
      padding: 25px 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f7fafc;
    }
    
    .photo-upload:hover {
      border-color: #f5a623;
      background: #fffaf0;
    }
    
    .photo-upload.has-image {
      border-style: solid;
      border-color: #f5a623;
      background: #fffaf0;
    }
    
    .upload-icon {
      font-size: 36px;
      color: #a0aec0;
      margin-bottom: 10px;
    }
    
    .upload-text {
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 5px;
    }
    
    .upload-hint {
      font-size: 12px;
      color: #718096;
    }
    
    .photo-preview {
      max-width: 100%;
      max-height: 150px;
      border-radius: 8px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .hidden-input {
      display: none;
    }
    
    .field-error {
      font-size: 13px;
      color: #e53e3e;
      margin-top: 5px;
      display: none;
    }
    
    .field-hint {
      font-size: 13px;
      color: #718096;
      margin-top: 5px;
    }
    
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #06C755, #04b049);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      font-family: 'Kanit', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(6, 199, 85, 0.3);
    }
    
    .submit-btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .message {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: 500;
    }
    
    .message-success {
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      color: #22543d;
    }
    
    .message-error {
      background: #fed7d7;
      border: 1px solid #feb2b2;
      color: #c53030;
    }
    
    .message-info {
      background: #ebf8ff;
      border: 1px solid #90cdf4;
      color: #2a69ac;
    }
    
    .history-section {
      margin-top: 40px;
      display: none;
    }
    
    .history-table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
      font-size: 14px;
    }
    
    .history-table th {
      background: linear-gradient(135deg, #4a5568, #2d3748);
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .history-table td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: middle;
    }
    
    .history-table tbody tr:hover {
      background: #f7fafc;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-complete {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .status-incomplete {
      background: #fed7d7;
      color: #c53030;
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 12px;
      color: #a0aec0;
      background: #f7fafc;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        border-radius: 15px;
      }
      
      .header {
        padding: 25px 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .content {
        padding: 30px 20px;
      }
      
      .summary-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .photo-section {
        grid-template-columns: 1fr;
      }
      
      .summary-header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
    }
    
    @media (max-width: 480px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="pageTitle">ลงเวลาเลิกงาน</h1>
      <div class="time" id="currentTime"></div>
    </div>
    
    <div class="content">
      <!-- Work Summary Section -->
      <div class="work-summary">
        <div class="summary-header">
          <div class="summary-title">สรุปการทำงานวันนี้</div>
          <div class="work-status" id="workStatus">กำลังโหลด...</div>
        </div>
        <div class="summary-grid" id="summaryGrid">
          <div class="summary-item">
            <div class="summary-label">เวลาเริ่มงาน</div>
            <div class="summary-value" id="startTimeDisplay">-</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">เลขไมล์เริ่มงาน</div>
            <div class="summary-value" id="startMileageDisplay">-</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">ชั่วโมงการทำงาน</div>
            <div class="summary-value" id="workHoursDisplay">-</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">ระยะทางรวม</div>
            <div class="summary-value" id="totalDistanceDisplay">-</div>
          </div>
        </div>
      </div>
      
      <!-- End Work Form -->
      <div class="form-section" id="endWorkSection">
        <h2 class="section-title">ข้อมูลเลิกงาน</h2>
        
        <form id="endWorkForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label required" for="endTime">เวลาเลิกงาน</label>
              <input type="time" id="endTime" class="form-input" required>
              <div class="field-hint">เลือกเวลาที่เลิกทำงานจริง</div>
              <div class="field-error" id="endTimeError"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label required" for="endMileage">เลขไมล์เลิกงาน</label>
              <input type="number" id="endMileage" class="form-input" placeholder="123456.7" step="0.1" min="0" required>
              <div class="field-hint">เลขไมล์ปัจจุบันในมาตรวัดรถ</div>
              <div class="field-error" id="endMileageError"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label required" for="trips">จำนวนรอบงานที่วิ่ง</label>
              <input type="number" id="trips" class="form-input" placeholder="5" min="0" required>
              <div class="field-hint">รอบงานทั้งหมดที่ไปส่งในวันนี้</div>
              <div class="field-error" id="tripsError"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label required" for="totalDeliveries">จำนวนจุดนำออกส่งทั้งหมด</label>
              <input type="number" id="totalDeliveries" class="form-input" placeholder="20" min="0" required>
              <div class="field-hint">จุดส่งทั้งหมดที่รับผิดชอบ</div>
              <div class="field-error" id="totalDeliveriesError"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label required" for="successfulDeliveries">จำนวนจุดที่ส่งสำเร็จ</label>
              <input type="number" id="successfulDeliveries" class="form-input" placeholder="18" min="0" required>
              <div class="field-hint">จุดส่งที่สำเร็จ (ต้องไม่เกินจำนวนทั้งหมด)</div>
              <div class="field-error" id="successfulDeliveriesError"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="notes">ระบุ/หมายเหตุ</label>
              <textarea id="notes" class="form-textarea" placeholder="บันทึกเพิ่มเติม เช่น ปัญหาที่พบ, ข้อเสนอแนะ หรือเหตุการณ์พิเศษ"></textarea>
              <div class="field-hint">ข้อมูลเพิ่มเติมสำหรับการทำงานในวันนี้</div>
            </div>
          </div>
          
          <h3 class="section-title">รูปภาพเลิกงาน</h3>
          <div class="photo-section">
            <div class="form-group">
              <label class="form-label required">รูปเลขไมล์เลิกงาน</label>
              <div class="photo-upload" onclick="document.getElementById('endMileagePhoto').click()">
                <div class="upload-content">
                  <div class="upload-icon">📷</div>
                  <div class="upload-text">ถ่ายรูปเลขไมล์</div>
                  <div class="upload-hint">แตะเพื่อถ่ายรูป</div>
                </div>
                <input type="file" id="endMileagePhoto" class="hidden-input" accept="image/*" capture="environment" required>
                <img id="endMileagePreview" class="photo-preview" style="display: none">
              </div>
              <div class="field-error" id="endMileagePhotoError"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label required">รูปพนักงานเลิกงาน</label>
              <div class="photo-upload" onclick="document.getElementById('endEmployeePhoto').click()">
                <div class="upload-content">
                  <div class="upload-icon">🤳</div>
                  <div class="upload-text">ถ่ายรูปตัวเอง</div>
                  <div class="upload-hint">แตะเพื่อถ่ายรูป</div>
                </div>
                <input type="file" id="endEmployeePhoto" class="hidden-input" accept="image/*" capture="user" required>
                <img id="endEmployeePreview" class="photo-preview" style="display: none">
              </div>
              <div class="field-error" id="endEmployeePhotoError"></div>
            </div>
          </div>
          
          <button type="submit" class="submit-btn" id="submitBtn">
            บันทึกข้อมูลเลิกงาน
          </button>
        </form>
      </div>
      
      <div id="message" style="display: none;"></div>
      
      <!-- Work History Section -->
      <div class="history-section" id="historySection">
        <h2 class="section-title">ประวัติการทำงาน 5 วันล่าสุด</h2>
        <div class="history-table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>วันที่</th>
                <th>เวลาเริ่ม</th>
                <th>ไมล์เริ่ม</th>
                <th>เวลาเลิก</th>
                <th>ไมล์เลิก</th>
                <th>ชั่วโมง</th>
                <th>ระยะทาง</th>
                <th>รอบงาน</th>
                <th>จุดทั้งหมด</th>
                <th>สำเร็จ</th>
                <th>ไม่สำเร็จ</th>
                <th>สถานะ</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <div>ระบบลงเวลาทำงาน BigC Delivery Service</div>
      <div>Powered by LINE LIFF • Version 2.0</div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="./config.js"></script>
  
  <script>
    let userProfile = null;
    let workData = null;
    let isSubmitting = false;
    let isReadOnlyMode = false;
    
    /**
     * Update current time display
     */
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('th-TH', {
        weekday: 'long',
        year: 'numeric',
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      document.getElementById('currentTime').textContent = timeString;
    }
    
    /**
     * Set current time as default
     */
    function setDefaultTime() {
      const now = new Date();
      const timeString = now.toTimeString().substring(0, 5);
      document.getElementById('endTime').value = timeString;
    }
    
    /**
     * Calculate working hours
     */
    function calculateWorkingHours(startTime, endTime) {
      if (!startTime || !endTime) return 0;
      
      const today = new Date().toISOString().split('T')[0];
      const start = new Date(`${today}T${startTime}:00`);
      let end = new Date(`${today}T${endTime}:00`);
      
      // Handle overnight work
      if (end <= start) {
        end.setDate(end.getDate() + 1);
      }
      
      const diffMs = end.getTime() - start.getTime();
      const diffHours = diffMs / (1000 * 60 * 60);
      
      return Math.max(0, diffHours);
    }
    
    /**
     * Update work summary display
     */
    function updateWorkSummary() {
      if (!workData) return;
      
      const startTime = workData['เวลาเริ่มงาน'] || '-';
      const startMileage = workData['เลขไมล์เริ่มงาน'] || '-';
      const endTime = document.getElementById('endTime').value || workData['เวลาเลิกงาน'] || '-';
      const endMileage = document.getElementById('endMileage').value || workData['เลขไมล์เลิกงาน'] || '-';
      
      document.getElementById('startTimeDisplay').textContent = startTime;
      document.getElementById('startMileageDisplay').textContent = startMileage !== '-' ? startMileage + ' กม.' : '-';
      
      // Calculate and display working hours
      if (startTime !== '-' && endTime !== '-') {
        const hours = calculateWorkingHours(startTime, endTime);
        document.getElementById('workHoursDisplay').textContent = hours > 0 ? hours.toFixed(1) + ' ชม.' : '-';
      }
      
      // Calculate and display total distance
      if (startMileage !== '-' && endMileage !== '-' && !isNaN(startMileage) && !isNaN(endMileage)) {
        const distance = Number(endMileage) - Number(startMileage);
        document.getElementById('totalDistanceDisplay').textContent = distance > 0 ? distance.toFixed(1) + ' กม.' : '-';
      }
    }
    
    /**
     * Show message to user
     */
    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.style.display = 'block';
      messageDiv.textContent = text;
      messageDiv.className = `message message-${type}`;
    }
    
    /**
     * Show field error
     */
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + 'Error');
      
      if (field && errorDiv) {
        field.classList.add('error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
    }
    
    /**
     * Clear field error
     */
    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + 'Error');
      
      if (field && errorDiv) {
        field.classList.remove('error');
        errorDiv.style.display = 'none';
      }
    }
    
    /**
     * Clear all field errors
     */
    function clearAllFieldErrors() {
      const fields = ['endTime', 'endMileage', 'trips', 'totalDeliveries', 'successfulDeliveries', 'endMileagePhoto', 'endEmployeePhoto'];
      fields.forEach(fieldId => clearFieldError(fieldId));
    }
    
    /**
     * Setup photo preview
     */
    function setupPhotoPreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const uploadContainer = input.closest('.photo-upload');
      
      input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        
        if (!file) {
          preview.style.display = 'none';
          uploadContainer.classList.remove('has-image');
          return;
        }
        
        try {
          InputValidator.validateImage(file);
          
          const base64 = await FileHandler.readFileAsBase64(file);
          preview.src = base64;
          preview.style.display = 'block';
          uploadContainer.classList.add('has-image');
          clearFieldError(inputId);
          
        } catch (error) {
          showFieldError(inputId, error.message);
          input.value = '';
          preview.style.display = 'none';
          uploadContainer.classList.remove('has-image');
        }
      });
    }
    
    /**
     * Setup real-time validation
     */
    function setupValidation() {
      // Time validation
      const endTimeInput = document.getElementById('endTime');
      endTimeInput.addEventListener('change', () => {
        updateWorkSummary();
        if (endTimeInput.value) {
          try {
            InputValidator.validateTime(endTimeInput.value);
            clearFieldError('endTime');
          } catch (error) {
            showFieldError('endTime', error.message);
          }
        }
      });
      
      // Mileage validation with real-time calculation
      const endMileageInput = document.getElementById('endMileage');
      endMileageInput.addEventListener('input', () => {
        updateWorkSummary();
        if (endMileageInput.value && workData) {
          try {
            const endMileage = InputValidator.validateMileage(endMileageInput.value);
            const startMileage = Number(workData['เลขไมล์เริ่มงาน'] || 0);
            
            if (endMileage <= startMileage) {
              throw new Error('เลขไมล์เลิกงานต้องมากกว่าเลขไมล์เริ่มงาน');
            }
            
            clearFieldError('endMileage');
          } catch (error) {
            showFieldError('endMileage', error.message);
          }
        }
      });
      
      // Cross-validation for deliveries
      const totalDelInput = document.getElementById('totalDeliveries');
      const successDelInput = document.getElementById('successfulDeliveries');
      
      const validateDeliveries = () => {
        const total = Number(totalDelInput.value || 0);
        const success = Number(successDelInput.value || 0);
        
        if (total > 0 && success > total) {
          showFieldError('successfulDeliveries', 'จำนวนสำเร็จต้องไม่เกินจำนวนทั้งหมด');
        } else {
          clearFieldError('successfulDeliveries');
          clearFieldError('totalDeliveries');
        }
      };
      
      totalDelInput.addEventListener('input', validateDeliveries);
      successDelInput.addEventListener('input', validateDeliveries);
      
      // Photo previews
      setupPhotoPreview('endMileagePhoto', 'endMileagePreview');
      setupPhotoPreview('endEmployeePhoto', 'endEmployeePreview');
    }
    
    /**
     * Setup form submission
     */
    function setupFormSubmission() {
      const form = document.getElementById('endWorkForm');
      const submitBtn = document.getElementById('submitBtn');
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (isSubmitting || isReadOnlyMode) return;
        
        try {
          isSubmitting = true;
          submitBtn.disabled = true;
          submitBtn.textContent = 'กำลังบันทึกข้อมูล...';
          
          clearAllFieldErrors();
          
          // Get form data
          const endTime = document.getElementById('endTime').value;
          const endMileage = document.getElementById('endMileage').value;
          const trips = document.getElementById('trips').value;
          const totalDeliveries = document.getElementById('totalDeliveries').value;
          const successfulDeliveries = document.getElementById('successfulDeliveries').value;
          const notes = document.getElementById('notes').value;
          const mileagePhoto = document.getElementById('endMileagePhoto').files[0];
          const employeePhoto = document.getElementById('endEmployeePhoto').files[0];
          
          // Validate required fields
          if (!endTime) throw new Error('กรุณาเลือกเวลาเลิกงาน');
          if (!endMileage) throw new Error('กรุณากรอกเลขไมล์เลิกงาน');
          if (!trips) throw new Error('กรุณากรอกจำนวนรอบงาน');
          if (!totalDeliveries) throw new Error('กรุณากรอกจำนวนจุดส่งทั้งหมด');
          if (!successfulDeliveries) throw new Error('กรุณากรอกจำนวนจุดส่งสำเร็จ');
          if (!mileagePhoto) throw new Error('กรุณาถ่ายรูปเลขไมล์');
          if (!employeePhoto) throw new Error('กรุณาถ่ายรูปพนักงาน');
          
          // Validate individual fields
          const validatedTime = InputValidator.validateTime(endTime);
          const validatedMileage = InputValidator.validateMileage(endMileage);
          const validatedTrips = InputValidator.validateTrips(trips);
          const validatedTotal = InputValidator.validateDeliveries(totalDeliveries);
          const validatedSuccess = InputValidator.validateDeliveries(successfulDeliveries);
          
          // Additional business logic validation
          if (validatedSuccess > validatedTotal) {
            throw new Error('จำนวนจุดส่งสำเร็จต้องไม่เกินจำนวนทั้งหมด');
          }
          
          const startMileage = Number(workData['เลขไมล์เริ่มงาน'] || 0);
          if (validatedMileage <= startMileage) {
            throw new Error('เลขไมล์เลิกงานต้องมากกว่าเลขไมล์เริ่มงาน');
          }
          
          // Convert photos to base64
          showMessage('กำลังประมวลผลรูปภาพ...', 'info');
          const mileageBase64 = await FileHandler.readFileAsBase64(mileagePhoto);
          const employeeBase64 = await FileHandler.readFileAsBase64(employeePhoto);
          
          // Prepare payload
          const payload = {
            userId: userProfile.userId,
            endTime: validatedTime,
            endMileage: validatedMileage,
            trips: validatedTrips,
            totalDeliveries: validatedTotal,
            successfulDeliveries: validatedSuccess,
            notes: notes.trim(),
            endMileagePhoto: mileageBase64,
            endEmployeePhoto: employeeBase64
          };
          
          // Submit to backend
          showMessage('กำلังส่งข้อมูลไปยังเซิร์ฟเวอร์...', 'info');
          const response = await ApiClient.serverCall('saveEndWork', [payload]);
          
          if (response.status === 'error') {
            throw new Error(response.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          }
          
          // Success
          showMessage('บันทึกข้อมูลเลิกงานเรียบร้อย! 🎉', 'success');
          
          // Switch to read-only mode
          switchToReadOnlyMode();
          
          // Auto close after delay
          setTimeout(() => {
            if (liff.isInClient()) {
              liff.closeWindow();
            } else {
              showMessage('คุณสามารถปิดหน้าต่างนี้ได้แล้ว', 'info');
            }
          }, 3000);
          
        } catch (error) {
          console.error('End work submission error:', error);
          
          // Handle specific validation errors
          if (error.message.includes('เวลา')) {
            showFieldError('endTime', error.message);
          } else if (error.message.includes('ไมล์')) {
            showFieldError('endMileage', error.message);
          } else if (error.message.includes('รอบงาน')) {
            showFieldError('trips', error.message);
          } else if (error.message.includes('จุดส่งทั้งหมด')) {
            showFieldError('totalDeliveries', error.message);
          } else if (error.message.includes('จุดส่งสำเร็จ')) {
            showFieldError('successfulDeliveries', error.message);
          } else if (error.message.includes('รูปไมล์')) {
            showFieldError('endMileagePhoto', error.message);
          } else if (error.message.includes('รูปพนักงาน')) {
            showFieldError('endEmployeePhoto', error.message);
          } else {
            showMessage('เกิดข้อผิดพลาด: ' + error.message, 'error');
          }
          
        } finally {
          isSubmitting = false;
          submitBtn.disabled = isReadOnlyMode;
          submitBtn.textContent = isReadOnlyMode ? 'บันทึกเรียบร้อยแล้ว' : 'บันทึกข้อมูลเลิกงาน';
        }
      });
    }
    
    /**
     * Switch form to read-only mode
     */
    function switchToReadOnlyMode() {
      isReadOnlyMode = true;
      
      // Update page title and status
      document.getElementById('pageTitle').textContent = 'สรุปการทำงาน';
      document.getElementById('workStatus').textContent = 'เสร็จสิ้น';
      document.getElementById('workStatus').className = 'work-status status-completed';
      
      // Make all inputs read-only
      const inputs = document.querySelectorAll('#endWorkForm input, #endWorkForm textarea');
      inputs.forEach(input => {
        if (input.type !== 'file') {
          input.readOnly = true;
        } else {
          input.disabled = true;
        }
      });
      
      // Hide photo upload functionality
      document.querySelectorAll('.photo-upload').forEach(upload => {
        upload.style.cursor = 'default';
        upload.onclick = null;
      });
      
      // Update submit button
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'บันทึกเรียบร้อยแล้ว';
      
      // Update work summary
      updateWorkSummary();
      
      showMessage('ข้อมูลแสดงเป็นโหมดอ่านอย่างเดียว', 'info');
    }
    
    /**
     * Load and display work history
     */
    async function loadWorkHistory() {
      try {
        const history = await ApiClient.serverCall('getWorkHistory', [userProfile.userId], {
          showLoading: false
        });
        
        if (history && history.length > 0) {
          const tbody = document.getElementById('historyTableBody');
          tbody.innerHTML = '';
          
          history.forEach(record => {
            const row = document.createElement('tr');
            
            const isComplete = record['เวลาเลิกงาน'] && record['เวลาเลิกงาน'] !== '';
            const statusBadge = isComplete 
              ? '<span class="status-badge status-complete">เสร็จสิ้น</span>'
              : '<span class="status-badge status-incomplete">ไม่สมบูรณ์</span>';
            
            row.innerHTML = `
              <td>${record['ข้อมูลงานวันที่'] || '-'}</td>
              <td>${record['เวลาเริ่มงาน'] || '-'}</td>
              <td>${record['เลขไมล์เริ่มงาน'] || '-'}</td>
              <td>${record['เวลาเลิกงาน'] || '-'}</td>
              <td>${record['เลขไมล์เลิกงาน'] || '-'}</td>
              <td>${record['จำนวนชั่วโมงการทำงาน'] || '-'}</td>
              <td>${record['ระยะทางรวม'] || '-'}</td>
              <td>${record['จำนวนรอบงานที่วิ่ง'] || '-'}</td>
              <td>${record['จำนวนจุดที่นำออกส่งทั้งหมด'] || '-'}</td>
              <td>${record['จำนวนจุดที่ส่งสำเร็จ'] || '-'}</td>
              <td>${record['จำนวนจุดที่ส่งไม่สำเร็จ'] || '-'}</td>
              <td>${statusBadge}</td>
            `;
            
            tbody.appendChild(row);
          });
          
          document.getElementById('historySection').style.display = 'block';
        }
        
      } catch (error) {
        console.error('Failed to load work history:', error);
      }
    }
    
    /**
     * Initialize the page
     */
    async function initializePage() {
      try {
        // Start time updates
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        setDefaultTime();
        
        // Get user profile
        userProfile = await LIFFUtils.initializeAndGetProfile();
        if (!userProfile) return;
        
        // Check work state
        const workState = await ApiClient.serverCall('getWorkStateForToday', [userProfile.userId]);
        
        if (workState.status === 'NO_EMP') {
          showMessage('ยังไม่ได้ลงทะเบียน กำลังนำทางไปหน้าลงทะเบียน...', 'error');
          setTimeout(() => {
            window.location.href = './register-improved.html';
          }, 2000);
          return;
        }
        
        if (workState.status === 'NOT_STARTED') {
          showMessage('ยังไม่ได้เริ่มงาน กำลังนำทางไปหน้าเริ่มงาน...', 'error');
          setTimeout(() => {
            window.location.href = './start-improved.html';
          }, 2000);
          return;
        }
        
        workData = workState.workData;
        
        // Update work status display
        const statusElement = document.getElementById('workStatus');
        if (workState.status === 'COMPLETED') {
          statusElement.textContent = 'เสร็จสิ้น';
          statusElement.className = 'work-status status-completed';
          
          // Fill form with existing data and switch to read-only
          if (workData) {
            document.getElementById('endTime').value = workData['เวลาเลิกงาน'] || '';
            document.getElementById('endMileage').value = workData['เลขไมล์เลิกงาน'] || '';
            document.getElementById('trips').value = workData['จำนวนรอบงานที่วิ่ง'] || '';
            document.getElementById('totalDeliveries').value = workData['จำนวนจุดที่นำออกส่งทั้งหมด'] || '';
            document.getElementById('successfulDeliveries').value = workData['จำนวนจุดที่ส่งสำเร็จ'] || '';
            document.getElementById('notes').value = workData['ระบุ/หมายเหตุ'] || '';
          }
          
          switchToReadOnlyMode();
          
        } else if (workState.status === 'STARTED_NOT_ENDED') {
          statusElement.textContent = 'กำลังทำงาน';
          statusElement.className = 'work-status status-in-progress';
          
          // Setup form for data entry
          setupValidation();
          setupFormSubmission();
          showMessage('กรอกข้อมูลด้านล่างเพื่อลงเวลาเลิกงาน', 'info');
        }
        
        // Update work summary
        updateWorkSummary();
        
        // Load work history
        loadWorkHistory();
        
      } catch (error) {
        console.error('Initialization error:', error);
        showMessage('เกิดข้อผิดพลาด: ' + error.message, 'error');
      }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
