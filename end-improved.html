<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ลงเวลาเลิกงาน / สรุป - BigC v3</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #f5a623 0%, #f39c12 100%); padding: 30px; text-align: center; color: white; }
    .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
    .header .time { font-size: 18px; opacity: 0.9; }
    .content { padding: 40px 30px; }
    .work-summary { background: linear-gradient(135deg, #f0fff4, #e6fffa); border: 1px solid #68d391; border-radius: 15px; padding: 25px; margin-bottom: 30px; }
    .summary-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .summary-title { font-size: 20px; font-weight: 700; color: #22543d; }
    .work-status { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-in-progress { background: #fef5e7; color: #744210; }
    .status-completed { background: #f0fff4; color: #22543d; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .summary-item { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); text-align: center; }
    .summary-label { font-size: 13px; color: #718096; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .summary-value { font-size: 24px; font-weight: 700; color: #2d3748; }
    .form-section { margin-bottom: 40px; }
    .section-title { font-size: 20px; font-weight: 600; color: #2d3748; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .form-group { margin-bottom: 25px; }
    .form-label { display: block; font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
    .form-label.required::after { content: ' *'; color: #e53e3e; }
    .form-input, .form-textarea { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-family: 'Kanit', sans-serif; transition: all 0.3s ease; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: #f5a623; box-shadow: 0 0 0 3px rgba(245, 166, 35, 0.1); }
    .form-input:read-only { background: #f7fafc; cursor: not-allowed; }
    .form-input.error { border-color: #e53e3e; box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1); }
    .form-textarea { resize: vertical; min-height: 100px; }
    .photo-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .photo-upload { border: 3px dashed #cbd5e0; border-radius: 12px; padding: 25px 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f7fafc; }
    .photo-upload:hover { border-color: #f5a623; background: #fffaf0; }
    .photo-upload.has-image { border-style: solid; border-color: #f5a623; background: #fffaf0; }
    .upload-icon { font-size: 36px; color: #a0aec0; margin-bottom: 10px; }
    .upload-text { font-size: 14px; font-weight: 500; color: #4a5568; margin-bottom: 5px; }
    .upload-hint { font-size: 12px; color: #718096; }
    .photo-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .hidden-input { display: none; }
    .field-error { font-size: 13px; color: #e53e3e; margin-top: 5px; display: none; }
    .field-hint { font-size: 13px; color: #718096; margin-top: 5px; }
    .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #06C755, #04b049); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; font-family: 'Kanit', sans-serif; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
    .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(6, 199, 85, 0.3); }
    .submit-btn:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; box-shadow: none; }
    .message { padding: 15px; border-radius: 10px; margin: 20px 0; font-weight: 500; text-align: center; }
    .message-success { background: #f0fff4; border: 1px solid #9ae6b4; color: #22543d; }
    .message-error { background: #fed7d7; border: 1px solid #feb2b2; color: #c53030; }
    .message-info { background: #ebf8ff; border: 1px solid #90cdf4; color: #2a69ac; }
    .history-section { margin-top: 40px; display: none; }
    .history-table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .history-table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 14px; }
    .history-table th { background: linear-gradient(135deg, #4a5568, #2d3748); color: white; padding: 15px 10px; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    .history-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
    .history-table tbody tr:hover { background: #f7fafc; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
    .status-complete { background: #c6f6d5; color: #22543d; }
    .status-incomplete { background: #fed7d7; color: #c53030; }
    .footer { text-align: center; padding: 20px; font-size: 12px; color: #a0aec0; background: #f7fafc; }
    .cors-info {
      background: #e8f5e8;
      border: 1px solid #27ae60;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      font-size: 14px;
      color: #155724;
      text-align: center;
      font-weight: 500;
    }
    @media (max-width: 768px) { body { padding: 10px; } .container { border-radius: 15px; } .header { padding: 25px 20px; } .header h1 { font-size: 24px; } .content { padding: 30px 20px; } .summary-grid { grid-template-columns: 1fr 1fr; } .form-grid, .photo-section { grid-template-columns: 1fr; } .summary-header { flex-direction: column; align-items: stretch; text-align: center; } }
    @media (max-width: 480px) { .summary-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="pageTitle">ลงเวลาเลิกงาน</h1>
      <div class="time" id="currentTime"></div>
    </div>
    
    <div class="content">
      <div class="cors-info">
        ✨ ใช้เทคนิค text/plain - ไม่มี CORS Error
      </div>

      <div class="work-summary">
        <div class="summary-header">
          <div class="summary-title">สรุปการทำงานวันนี้</div>
          <div class="work-status" id="workStatus">กำลังโหลด...</div>
        </div>
        <div class="summary-grid" id="summaryGrid">
          <div class="summary-item"><div class="summary-label">เวลาเริ่มงาน</div><div class="summary-value" id="startTimeDisplay">-</div></div>
          <div class="summary-item"><div class="summary-label">เลขไมล์เริ่มงาน</div><div class="summary-value" id="startMileageDisplay">-</div></div>
          <div class="summary-item"><div class="summary-label">ชั่วโมงการทำงาน</div><div class="summary-value" id="workHoursDisplay">-</div></div>
          <div class="summary-item"><div class="summary-label">ระยะทางรวม</div><div class="summary-value" id="totalDistanceDisplay">-</div></div>
        </div>
      </div>
      
      <div class="form-section" id="endWorkSection">
        <h2 class="section-title">ข้อมูลเลิกงาน</h2>
        <form id="endWorkForm" novalidate>
          <div class="form-grid">
            <div class="form-group"><label class="form-label required" for="endTime">เวลาเลิกงาน</label><input type="time" id="endTime" class="form-input" required><div class="field-error" id="endTimeError"></div></div>
            <div class="form-group"><label class="form-label required" for="endMileage">เลขไมล์เลิกงาน</label><input type="number" id="endMileage" class="form-input" placeholder="123456.7" step="0.1" min="0" required><div class="field-error" id="endMileageError"></div></div>
            <div class="form-group"><label class="form-label required" for="trips">จำนวนรอบงานที่วิ่ง</label><input type="number" id="trips" class="form-input" placeholder="5" min="0" required><div class="field-error" id="tripsError"></div></div>
            <div class="form-group"><label class="form-label required" for="totalDeliveries">จำนวนจุดนำออกส่งทั้งหมด</label><input type="number" id="totalDeliveries" class="form-input" placeholder="20" min="0" required><div class="field-error" id="totalDeliveriesError"></div></div>
            <div class="form-group"><label class="form-label required" for="successfulDeliveries">จำนวนจุดที่ส่งสำเร็จ</label><input type="number" id="successfulDeliveries" class="form-input" placeholder="18" min="0" required><div class="field-error" id="successfulDeliveriesError"></div></div>
            <div class="form-group"><label class="form-label" for="notes">ระบุ/หมายเหตุ</label><textarea id="notes" class="form-textarea" placeholder="ปัญหาที่พบ, ข้อเสนอแนะ"></textarea></div>
          </div>
          <h3 class="section-title">รูปภาพเลิกงาน</h3>
          <div class="photo-section">
            <div class="form-group"><label class="form-label required">รูปเลขไมล์เลิกงาน</label><div class="photo-upload" onclick="document.getElementById('endMileagePhoto').click()"><div class="upload-icon">📷</div><div class="upload-text">ถ่ายรูปเลขไมล์</div><input type="file" id="endMileagePhoto" class="hidden-input" accept="image/*" capture="environment" required><img id="endMileagePreview" class="photo-preview" style="display: none"></div><div class="field-error" id="endMileagePhotoError"></div></div>
            <div class="form-group"><label class="form-label required">รูปพนักงานเลิกงาน</label><div class="photo-upload" onclick="document.getElementById('endEmployeePhoto').click()"><div class="upload-icon">🤳</div><div class="upload-text">ถ่ายรูปตัวเอง</div><input type="file" id="endEmployeePhoto" class="hidden-input" accept="image/*" capture="user" required><img id="endEmployeePreview" class="photo-preview" style="display: none"></div><div class="field-error" id="endEmployeePhotoError"></div></div>
          </div>
          <button type="submit" class="submit-btn" id="submitBtn">บันทึกข้อมูลเลิกงาน</button>
        </form>
      </div>
      <div id="message" style="display: none;"></div>
      
      <div class="history-section" id="historySection">
        <h2 class="section-title">ประวัติการทำงาน 5 วันล่าสุด</h2>
        <div class="history-table-wrapper"><table class="history-table"><thead><tr><th>วันที่</th><th>เวลาเริ่ม</th><th>ไมล์เริ่ม</th><th>เวลาเลิก</th><th>ไมล์เลิก</th><th>ชั่วโมง</th><th>ระยะทาง</th><th>รอบงาน</th><th>จุดทั้งหมด</th><th>สำเร็จ</th><th>ไม่สำเร็จ</th><th>สถานะ</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
      </div>
    </div>
    
    <div class="footer">
      <div>ระบบลงเวลาทำงาน BigC Delivery Service</div>
      <div>Powered by LINE LIFF • Version 3.0 (CORS-Free)</div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="config-v3.js"></script>
  
  <script>
    let userProfile = null;
    let workData = null;
    let isSubmitting = false;

    const ui = {
        showMessage: (text, type = 'info') => {
            const el = document.getElementById('message');
            el.style.display = 'block';
            el.textContent = text;
            el.className = `message message-${type}`;
        },
        showFieldError: (fieldId, message) => {
            document.getElementById(fieldId).classList.add('error');
            const errorDiv = document.getElementById(fieldId + 'Error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        },
        clearFieldError: (fieldId) => {
            const field = document.getElementById(fieldId);
            if(field) field.classList.remove('error');
            const errorDiv = document.getElementById(fieldId + 'Error');
            if(errorDiv) errorDiv.style.display = 'none';
        },
        clearAllFieldErrors: () => ['endTime', 'endMileage', 'trips', 'totalDeliveries', 'successfulDeliveries', 'endMileagePhoto', 'endEmployeePhoto'].forEach(ui.clearFieldError),
        updateSummary: () => {
            if (!workData) return;
            const startMileage = parseFloat(workData['เลขไมล์เริ่มงาน'] || 0);
            const endMileage = parseFloat(document.getElementById('endMileage').value || workData['เลขไมล์เลิกงาน'] || 0);
            document.getElementById('startTimeDisplay').textContent = workData['เวลาเริ่มงาน'] || '-';
            document.getElementById('startMileageDisplay').textContent = `${workData['เลขไมล์เริ่มงาน'] || '-'} กม.`;
            if (endMileage > startMileage) {
                document.getElementById('totalDistanceDisplay').textContent = `${(endMileage - startMileage).toFixed(1)} กม.`;
            }
        },
        switchToReadOnly: () => {
            document.getElementById('pageTitle').textContent = 'สรุปการทำงาน';
            const statusEl = document.getElementById('workStatus');
            statusEl.textContent = 'เสร็จสิ้น';
            statusEl.className = 'work-status status-completed';
            document.querySelectorAll('#endWorkForm input, #endWorkForm textarea').forEach(el => {
                if(el.type !== 'file') el.readOnly = true;
                else el.disabled = true;
            });
            document.querySelectorAll('.photo-upload').forEach(el => el.onclick = null);
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'บันทึกเรียบร้อยแล้ว';
            ui.updateSummary();
        }
    };

    function setupPhotoPreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const uploadContainer = input.closest('.photo-upload');
        input.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                preview.style.display = 'none';
                uploadContainer.classList.remove('has-image');
                return;
            }
            try {
                InputValidator.validateImage(file);
                preview.src = await FileHandler.readFileAsBase64(file);
                preview.style.display = 'block';
                uploadContainer.classList.add('has-image');
                ui.clearFieldError(inputId);
            } catch (error) {
                ui.showFieldError(inputId, error.message);
                input.value = '';
                preview.style.display = 'none';
                uploadContainer.classList.remove('has-image');
            }
        });
    }

    function setupFormSubmission() {
        const form = document.getElementById('endWorkForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSubmitting) return;

            isSubmitting = true;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'กำลังบันทึก...';
            
            try {
                ui.clearAllFieldErrors();
                const formData = {
                    endTime: document.getElementById('endTime').value,
                    endMileage: document.getElementById('endMileage').value,
                    trips: document.getElementById('trips').value,
                    totalDeliveries: document.getElementById('totalDeliveries').value,
                    successfulDeliveries: document.getElementById('successfulDeliveries').value,
                    notes: document.getElementById('notes').value.trim(),
                    endMileagePhotoFile: document.getElementById('endMileagePhoto').files[0],
                    endEmployeePhotoFile: document.getElementById('endEmployeePhoto').files[0]
                };

                const startMileage = parseFloat(workData['เลขไมล์เริ่มงาน']);
                if (parseFloat(formData.endMileage) <= startMileage) {
                    throw { field: 'endMileage', message: 'เลขไมล์เลิกงานต้องมากกว่าเลขไมล์เริ่มงาน' };
                }
                if (parseInt(formData.successfulDeliveries) > parseInt(formData.totalDeliveries)) {
                    throw { field: 'successfulDeliveries', message: 'จำนวนสำเร็จต้องไม่เกินจำนวนทั้งหมด' };
                }
                InputValidator.validateImage(formData.endMileagePhotoFile);
                InputValidator.validateImage(formData.endEmployeePhotoFile);

                const payload = {
                    userId: userProfile.userId,
                    endTime: InputValidator.validateTime(formData.endTime),
                    endMileage: InputValidator.validateMileage(formData.endMileage),
                    trips: InputValidator.validateTrips(formData.trips),
                    totalDeliveries: InputValidator.validateDeliveries(formData.totalDeliveries),
                    successfulDeliveries: InputValidator.validateDeliveries(formData.successfulDeliveries),
                    notes: formData.notes
                };

                const [mileagePhoto, employeePhoto] = await Promise.all([
                    FileHandler.readFileAsBase64(formData.endMileagePhotoFile),
                    FileHandler.readFileAsBase64(formData.endEmployeePhotoFile)
                ]);
                payload.endMileagePhoto = mileagePhoto;
                payload.endEmployeePhoto = employeePhoto;
                
                await serverCall('saveEndWork', payload);

                workData = {...workData, ...formData};
                ui.switchToReadOnly();
                ui.showMessage('บันทึกข้อมูลเลิกงานเรียบร้อย!', 'success');
                setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 3000);

            } catch (error) {
                console.error('Submission error:', error);
                if (error.field) ui.showFieldError(error.field, error.message);
                else ui.showMessage('เกิดข้อผิดพลาด: ' + error.message, 'error');
                
                isSubmitting = false;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'บันทึกข้อมูลเลิกงาน';
            }
        });
    }

    async function loadWorkHistory() {
        try {
            const history = await serverCall('getWorkHistory', userProfile.userId);
            if (history && history.length > 0) {
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = history.map(rec => `
                    <tr>
                        <td>${rec['ข้อมูลงานวันที่'] || '-'}</td>
                        <td>${rec['เวลาเริ่มงาน'] || '-'}</td>
                        <td>${rec['เลขไมล์เริ่มงาน'] || '-'}</td>
                        <td>${rec['เวลาเลิกงาน'] || '-'}</td>
                        <td>${rec['เลขไมล์เลิกงาน'] || '-'}</td>
                        <td>${rec['จำนวนชั่วโมงการทำงาน'] || '-'}</td>
                        <td>${rec['ระยะทางรวม'] || '-'}</td>
                        <td>${rec['จำนวนรอบงานที่วิ่ง'] || '-'}</td>
                        <td>${rec['จำนวนจุดที่นำออกส่งทั้งหมด'] || '-'}</td>
                        <td>${rec['จำนวนจุดที่ส่งสำเร็จ'] || '-'}</td>
                        <td>${rec['จำนวนจุดที่ส่งไม่สำเร็จ'] || '-'}</td>
                        <td><span class="status-badge ${rec['เวลาเลิกงาน'] ? 'status-complete' : 'status-incomplete'}">${rec['เวลาเลิกงาน'] ? 'เสร็จสิ้น' : 'ไม่สมบูรณ์'}</span></td>
                    </tr>
                `).join('');
                document.getElementById('historySection').style.display = 'block';
            }
        } catch (error) {
            console.error('Failed to load work history:', error);
        }
    }
    
    async function initializePage() {
        const timeElement = document.getElementById('currentTime');
        const updateTime = () => timeElement.textContent = new Date().toLocaleString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        updateTime();
        setInterval(updateTime, 1000);
        document.getElementById('endTime').value = new Date().toTimeString().substring(0, 5);

        try {
            userProfile = await initializeLiffAndGetProfile();
            if (!userProfile) return;

            const workState = await serverCall('getWorkStateForToday', userProfile.userId);
            workData = workState.workData;

            if (workState.status === 'NO_EMP') {
                ui.showMessage('ยังไม่ได้ลงทะเบียน กำลังนำทาง...', 'error');
                return setTimeout(() => window.location.href = './register-v3.html', 2000);
            }
            if (workState.status === 'NOT_STARTED') {
                ui.showMessage('ยังไม่ได้เริ่มงาน กำลังนำทาง...', 'error');
                return setTimeout(() => window.location.href = './start-v3.html', 2000);
            }

            ui.updateSummary();
            loadWorkHistory();

            if (workState.status === 'COMPLETED') {
                Object.keys(workData).forEach(key => {
                    const el = document.getElementById({
                        'เวลาเลิกงาน': 'endTime', 'เลขไมล์เลิกงาน': 'endMileage',
                        'จำนวนรอบงานที่วิ่ง': 'trips', 'จำนวนจุดที่นำออกส่งทั้งหมด': 'totalDeliveries',
                        'จำนวนจุดที่ส่งสำเร็จ': 'successfulDeliveries', 'ระบุ/หมายเหตุ': 'notes'
                    }[key]);
                    if (el) el.value = workData[key];
                });
                ui.switchToReadOnly();
                ui.showMessage('ข้อมูลสำหรับวันนี้บันทึกเรียบร้อยแล้ว', 'info');
            } else {
                const statusEl = document.getElementById('workStatus');
                statusEl.textContent = 'กำลังทำงาน';
                statusEl.className = 'work-status status-in-progress';
                document.getElementById('endMileage').addEventListener('input', ui.updateSummary);
                setupPhotoPreview('endMileagePhoto', 'endMileagePreview');
                setupPhotoPreview('endEmployeePhoto', 'endEmployeePreview');
                setupFormSubmission();
                ui.showMessage('กรอกข้อมูลเพื่อลงเวลาเลิกงาน', 'info');
            }
        } catch (error) {
            console.error('Initialization error:', error);
            ui.showMessage('เกิดข้อผิดพลาดร้ายแรง: ' + error.message, 'error');
            document.getElementById('submitBtn').disabled = true;
        }
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
