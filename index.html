<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - BigC v3 (CORS-Free)</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Kanit', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      padding: 40px 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #06C755, #04b049);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      font-weight: bold;
    }
    
    .title {
      font-size: 24px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 16px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .version {
      font-size: 12px;
      color: #27ae60;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .menu-item {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px 15px;
      border-radius: 15px;
      text-decoration: none;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .menu-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .menu-item .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .menu-item .text {
      font-size: 14px;
      font-weight: 500;
    }
    
    .status-card {
      background: #e8f5e8;
      border: 1px solid #27ae60;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #155724;
    }
    
    @media (max-width: 480px) {
      .menu-grid {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">BC</div>
    <h1 class="title">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h1>
    <div class="subtitle">BigC Delivery System</div>
    <div class="version">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 3.0 - ‚ú® CORS-Free (text/plain trick)</div>
    
    <div class="status-card">
      ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Content-Type: text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS Error ‡πÅ‡∏ö‡∏ö 100% 
    </div>
    
    <div class="menu-grid">
      <a href="register-v3.html" class="menu-item">
        <div class="icon">üë§</div>
        <div class="text">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
      </a>
      
      <a href="start-v3.html" class="menu-item">
        <div class="icon">‚ñ∂Ô∏è</div>
        <div class="text">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>
      </a>
      
      <a href="end-v3.html" class="menu-item">
        <div class="icon">‚èπÔ∏è</div>
        <div class="text">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</div>
      </a>
      
      <a href="#" class="menu-item" onclick="showHistory()">
        <div class="icon">üìä</div>
        <div class="text">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
      </a>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="config-v3.js"></script>
  
  <script>
    let liffReady = false;
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });
    
    async function initializeApp() {
      try {
        console.log('üöÄ Initializing BigC Time Tracking System v3.0 (CORS-Free)...');
        
        // Test backend connection
        await testConnection();
        
        // Initialize LIFF
        if (typeof liff !== 'undefined') {
          await initializeLiff();
        } else {
          console.warn('‚ö†Ô∏è LIFF SDK not loaded');
        }
        
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message);
      }
    }
    
    async function testConnection() {
      try {
        console.log('üîå Testing CORS-free connection...');
        
        const response = await fetch(CONFIG.GAS_WEB_APP_URL, {
          method: 'GET'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Backend connection successful:', data);
        
        if (data.corsMethod === 'text/plain trick') {
          console.log('üéâ CORS-free method confirmed!');
        }
        
      } catch (error) {
        console.error('‚ùå Backend connection failed:', error);
        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend ‡πÑ‡∏î‡πâ');
      }
    }
    
    async function initializeLiff() {
      try {
        console.log('üì± Initializing LIFF...');
        
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          console.log('üîê User not logged in');
          // Don't auto-redirect, let user choose
        } else {
          liffReady = true;
          console.log('‚úÖ LIFF initialized successfully');
        }
        
      } catch (error) {
        console.error('‚ùå LIFF initialization failed:', error);
      }
    }
    
    async function showHistory() {
      let phone;
      
      if (liffReady) {
        try {
          const profile = await liff.getProfile();
          phone = profile.userId;
        } catch (error) {
          console.error('Failed to get LINE profile:', error);
        }
      }
      
      if (!phone) {
        phone = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:');
        if (!phone) return;
      }
      
      try {
        showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...');
        
        // üéØ ‡πÉ‡∏ä‡πâ serverCall function ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ text/plain
        const history = await serverCall('getWorkHistory', phone);
        
        hideLoading();
        
        if (history && history.length > 0) {
          showHistoryModal(history);
        } else {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');
        }
        
      } catch (error) {
        hideLoading();
        console.error('Failed to load history:', error);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ: ' + error.message);
      }
    }
    
    function showHistoryModal(history) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
      `;
      
      let historyHtml = '<h3 style="margin-bottom: 15px; text-align: center;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>';
      
      history.forEach(record => {
        historyHtml += `
          <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
            <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${record.date}</div>
            <div><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong> ${record.startTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
            <div><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö:</strong> ${record.endTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
            <div><strong>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå:</strong> ${record.startMileage || 0} - ${record.endMileage || 0}</div>
            <div><strong>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</strong> ${record.income || 0} ‡∏ö‡∏≤‡∏ó</div>
            <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß:</strong> ${record.trips || 0}</div>
            <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${record.status}</div>
          </div>
        `;
      });
      
      historyHtml += '<button onclick="this.closest(\'.history-modal\').remove()" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 10px; margin-top: 15px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>';
      
      content.innerHTML = historyHtml;
      modal.appendChild(content);
      modal.classList.add('history-modal');
      document.body.appendChild(modal);
      
      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
  </script>
</body>
</html>
